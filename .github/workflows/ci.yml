name: CI

on: 
push:
branches: [ main ]
pull_request: 
branches: [ main ]

jobs: 
test: 
runs-on: ubuntu-latest

services: 
postgres: 
image: postgres:15-alpine
env: 
POSTGRES_DB: inventory_db
POSTGRES_USER: inventory_user
POSTGRES_PASSWORD: inventory_pass
options: >-
  --health-cmd pg_isready
  --health-interval 10s
  --health-timeout 5s
  --health-retires 5
 ports:
   - 5432:5432

  steps: 
  - uses: actions/checkout@v4

  - name: Setup Node.js
    uses: actions/step-node@v4
    with: 
       node-version: '20'

  - name: Install dependencies
    run: npm ci
  
  - name: Run migrations
    env: 
      DATABASE_URL:
 postgresql://inventory_user:inventory_pass@localhost:5432/inventory_db
       run: npx node-pg-migrate up

   - name: Seed database
     env: 
        DATABASE_URL:
 postgresql://inventory_user:inventory_pass@localhost:5432/inventory_db
     run: psql $DATABASE_URL < seeds/001_demo_data.sql

    - name: Start server
      env:
        DATABASE_URL:
 postgresql://inventory_user:inventory_pass@localhost:5432/inventory_db
        PORT: 3000
      run: |
        npm start &
        sleep 5
    - name: Test health endpont
      run: |
        curl -f http://localhost:3000/health || exit 1
        curl -f http://localhost:3000/organizations || exit 1

